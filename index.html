<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TU IA DE ESTUDIO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Flat, Modern Palette */
            --color-background: #f8f9fa; /* Very light gray, almost white */
            --color-surface: #ffffff;    /* For cards, header, modals etc. */
            --color-text: #212529;       /* Dark gray for body text */
            --color-text-muted: #6c757d; /* Lighter gray for subtitles, placeholders */
            --color-primary: #007bff;    /* Standard Bootstrap Blue */
            --color-primary-light: #5dade2; 
            --color-primary-dark: #0056b3;  
            --color-accent: #6c757d;     /* A secondary/accent gray */
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-border: #dee2e6;     
            
            --font-main: 'Poppins', sans-serif;
            --color-primary-rgb: 0, 123, 255; 
            --color-accent-rgb: 108, 117, 125; 

            /* Neumorphic variables (kept for specific elements if needed) */
            --neumorphism-bg: #E0E5EC;
            --neumorphism-light-shadow: -9px -9px 16px #ffffff, 9px 9px 16px #a3b1c6;
            --neumorphism-light-shadow-inset: inset -7px -7px 14px #ffffff, inset 7px 7px 14px #a3b1c6;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6; 
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; 
        }

        .card-base {
            background-color: var(--color-surface);
            border-radius: 12px; 
            padding: clamp(1.5rem, 4vw, 2rem);
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        
        .neumorphic-card { 
            background-color: var(--neumorphism-bg);
            border-radius: 25px; 
            padding: clamp(1.5rem, 5vw, 2.5rem); 
            box-shadow: var(--neumorphism-light-shadow);
            transition: box-shadow 0.25s ease-in-out;
        }
        .neumorphic-card:hover {
            box-shadow: -6px -6px 12px #ffffff, 6px 6px 12px #a3b1c6; 
        }
        
        .flat-card { 
             box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .flat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .button-base {
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            outline: none;
            text-align: center;
        }

        .neumorphic-button { 
            background-color: var(--neumorphism-bg);
            border-radius: 15px;
            padding: 0.8rem 1.8rem;
            font-weight: 600;
            color: var(--color-primary); 
            box-shadow: var(--neumorphism-light-shadow);
        }
        .neumorphic-button:hover {
            color: var(--color-primary-dark); 
            box-shadow: -6px -6px 12px #ffffff, 6px 6px 12px #a3b1c6; 
        }
        .neumorphic-button:active {
            box-shadow: var(--neumorphism-light-shadow-inset);
            color: var(--color-primary-light); 
            transform: translateY(1px); 
        }
        .neumorphic-button-primary { 
            color: white;
            background-color: var(--color-primary);
        }
        .neumorphic-button-primary:hover {
            background-color: var(--color-primary-dark);
            color: white; 
        }
        .neumorphic-button-primary:active {
             background-color: var(--color-primary-light);
             color: white; 
        }
        .neumorphic-button.disabled, .neumorphic-button:disabled {
            opacity: 0.7;
            box-shadow: var(--neumorphism-light-shadow-inset); 
            cursor: not-allowed;
        }

        .flat-button { 
            color: var(--color-primary);
            background-color: transparent;
            border: 1px solid var(--color-primary);
        }
        .flat-button:hover {
            background-color: var(--color-primary);
            color: var(--color-surface);
        }
        .flat-button-primary { 
            background-color: var(--color-primary);
            color: var(--color-surface);
            border: 1px solid var(--color-primary);
        }
        .flat-button-primary:hover {
            background-color: var(--color-primary-dark);
            border-color: var(--color-primary-dark);
        }
        .flat-button.disabled, .flat-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--color-text-muted);
            border-color: var(--color-text-muted);
            color: var(--color-surface);
        }

        .input-base {
            border: 1px solid var(--color-border); 
            border-radius: 8px;
            padding: 0.75rem 1.2rem;
            color: var(--color-text);
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--color-surface); 
        }
        .input-base:focus {
            outline: none;
            border-color: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.25);
        }

        .neumorphic-input {
            background-color: var(--neumorphism-bg);
            border-radius: 15px;
            padding: 0.9rem 1.2rem;
            box-shadow: var(--neumorphism-light-shadow-inset);
            color: var(--color-text); 
            width: 100%;
            transition: box-shadow 0.2s ease;
        }
        .neumorphic-input:focus {
            outline: none;
            box-shadow: var(--neumorphism-light-shadow-inset), 
                        0 0 0 3px rgba(var(--color-primary-rgb), 0.25); 
        }
        
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background-color: var(--color-surface); 
            margin: auto; padding: clamp(25px, 5vw, 35px); border-radius: 12px; 
            width: 90%; max-width: 500px; position: relative; text-align: left;
            animation: slideInModal 0.3s ease-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        .modal-content.neumorphic-modal-card { 
            background-color: var(--neumorphism-bg);
            border-radius: 25px;
            box-shadow: var(--neumorphism-light-shadow);
        }

        @keyframes slideInModal { from { transform: translateY(-25px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close {
            color: var(--color-text); position: absolute; top: 15px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s;
        }
        .modal-close:hover { color: var(--color-primary); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e9ecef; } 
        ::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: #6c757d; }

        .text-primary { color: var(--color-primary); }
        .text-accent { color: var(--color-accent); }
        .bg-primary-light-transparent { background-color: rgba(var(--color-primary-rgb), 0.05); }
        
        #mainHeader nav a { 
            margin: 0 10px; 
            padding: 6px 12px; 
            border-radius: 6px; 
            transition: color 0.2s, background-color 0.2s;
            font-weight: 500;
            color: var(--color-text); 
        }
        #mainHeader nav a:hover {
            color: var(--color-primary);
            background-color: rgba(var(--color-primary-rgb), 0.07); 
        }
        #mainHeader nav a.active-link {
            color: var(--color-primary-dark);
            font-weight: 600;
        }

        #mobileMenuBtn { display: none; } 
        @media (max-width: 768px) {
            #mainHeaderContainer { flex-wrap: wrap; }
            #mainNav { 
                display: none; 
                flex-direction: column; 
                width: 100%; 
                order: 3; 
                margin-top: 0.5rem; 
                background-color: var(--color-surface); 
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.07); 
                padding: 0.5rem 0;
            }
            #mainNav.active { display: flex; } 
            #mainNav a { margin: 6px 0; display:block; text-align: center; width: 95%; margin-left:auto; margin-right:auto; padding: 10px 0;}
            #mobileMenuBtn { display: block; background-color: transparent; border: none; box-shadow: none; color: var(--color-primary); padding: 0.5rem; } 
            #mobileMenuBtn:hover { background-color: rgba(var(--color-primary-rgb), 0.07); }
            .user-profile-container { margin-top: 0.5rem; width:100%; justify-content: center;}
        }
        .user-profile-container { display: flex; align-items: center; }
        #userAvatar { border: 2px solid var(--color-primary-light); box-shadow: none; } 

        .section-title {
            font-size: clamp(2rem, 5vw, 3rem); 
            font-weight: 700; 
            color: #212529; 
            margin-bottom: 1rem; 
            text-align: center;
            letter-spacing: -0.025em; 
        }
        .section-subtitle {
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            color: #495057; 
            text-align: center;
            margin-bottom: 2.5rem; 
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        .feature-icon {
            font-size: 1.8rem; 
            color: var(--color-primary);
            margin-right: 0.75rem;
            width: 35px; 
            text-align: center;
        }
        .feature-title { 
            font-size: 1.2rem; 
            font-weight: 600;
            color: var(--color-primary-dark);
        }

        #progressChartContainer {
            position: relative; height: 350px; 
            width: 100%; max-width: 750px; margin: 2rem auto;
            padding: 1rem; background-color: var(--color-surface); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .clickable-card:focus-within { 
             box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 0 3px rgba(var(--color-primary-rgb), 0.3);
        }
        main > section {
            padding-top: 3rem; 
            padding-bottom: 3rem; 
        }
        main > section:first-child { 
            padding-top: 0; 
            padding-bottom: 0; 
        }
        /* AI Tools Tab Styling */
        #ia-tools-tabs .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* 8px */
            font-weight: 500;
            color: var(--color-text-muted);
            background-color: transparent;
            border: 1px solid transparent; /* For consistent height */
            transition: all 0.2s ease-in-out;
        }
        #ia-tools-tabs .tab-button:hover {
            background-color: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }
        #ia-tools-tabs .tab-button.active {
            background-color: var(--color-primary) !important; /* Tailwind was overriding this, so !important */
            color: white !important;
            box-shadow: 0 2px 4px rgba(var(--color-primary-rgb), 0.3);
        }
        #ia-tools-content .tab-content {
            padding-top: 1.5rem; /* Add some space below the tabs */
        }
        /* Ensure neumorphic cards inside AI tools still look okay with new primary color for text */
        #ia-tools-content .neumorphic-card .text-primary {
             color: var(--color-primary) !important;
        }
        #ia-tools-content .neumorphic-card .font-semibold.text-primary {
            color: var(--color-primary) !important;
        }
         /* Flashcard neumorphic adjustments */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 350px; /* Max width for flashcard */
            height: 220px; /* Increased height */
            margin: 1.5rem auto; /* Centering */
        }
        .flashcard {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.7s; cursor: pointer;
        }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; justify-content: center;
            align-items: center; padding: 20px; 
            border-radius: 15px; /* Match neumorphic card radius */
            font-size: 0.9rem; /* Adjusted font size */
        }
        .flashcard-front {
            background-color: var(--neumorphism-bg);
            box-shadow: var(--neumorphism-light-shadow);
            color: var(--color-text);
        }
        .flashcard-back {
            background-color: var(--neumorphism-bg); /* Could be slightly different for distinction */
            box-shadow: var(--neumorphism-light-shadow);
            color: var(--color-primary-dark); /* Use primary color for answer */
            transform: rotateY(180deg);
        }
        /* Styling for buttons controlling flashcards if they are neumorphic */
        #prevFlashcard, #nextFlashcard {
            /* Apply .neumorphic-button styles if not already applied via class */
            /* For example, if they are plain buttons, add: */
            /* class="neumorphic-button text-sm" */
        }


    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="antialiased">

    <!-- Header -->
    <header id="mainHeader" class="sticky top-0 z-50 bg-surface shadow-sm">
        <div id="mainHeaderContainer" class="container mx-auto flex justify-between items-center py-4 px-6">
            <a href="#" class="text-2xl font-bold text-primary">TU IA DE ESTUDIO</a>
            <button id="mobileMenuBtn" class="md:hidden text-primary">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <nav id="mainNav" class="hidden md:flex items-center space-x-1">
                <a href="#hero" class="nav-link">Inicio</a>
                <a href="#ia-tools" class="nav-link">Herramientas</a> {/* Changed href to point to new AI tools section */}
                <a href="#como-funciona" class="nav-link">Cómo Funciona</a> 
                <a href="#progreso-dev" class="nav-link">Tu Progreso</a>
                <a href="#" id="dashboardLink" class="nav-link hidden">Dashboard</a>
                <div id="authButtons" class="ml-4 flex items-center space-x-2">
                    <button id="loginBtn" class="button-base flat-button-primary px-4 py-2 text-sm">Login</button>
                </div>
                <div id="userProfileContainer" class="user-profile-container hidden ml-3">
                    <img id="userAvatar" src="https://via.placeholder.com/36?text=U" alt="User Avatar" class="w-9 h-9 rounded-full">
                    <span id="userName" class="ml-2 font-medium text-sm text-gray-700"></span>
                    <button id="logoutBtn" class="button-base flat-button text-xs !p-2 ml-2">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main> 
        <!-- Hero Section (Replaces #vision) -->
        <section id="hero" class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-20 md:py-32 text-center scroll-mt-16">
            <div class="container mx-auto px-6 max-w-3xl">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-gray-800 mb-6">
                    La Forma Inteligente de Dominar tus Estudios
                </h1>
                <p class="text-lg md:text-xl text-gray-600 mb-10">
                    Descubre herramientas IA que personalizan tu aprendizaje, optimizan tu tiempo y te ayudan a alcanzar tus metas académicas.
                </p>
                <button id="heroCtaBtn" class="button-base flat-button-primary text-lg px-8 py-3 transform hover:scale-105">
                    Comienza Gratis
                </button>
            </div>
        </section>
        
        <!-- AI Tools Section - This replaces the old #caracteristicas section -->
        <section id="ia-tools" class="bg-white scroll-mt-16 py-16 md:py-24">
            <div class="container mx-auto px-6">
                <h2 class="section-title">Herramientas IA a Tu Servicio</h2>
                <p class="section-subtitle">Desde resúmenes hasta generación de preguntas, tenemos lo que necesitas.</p>
                
                <div id="ia-tools-tabs" class="mb-8 flex flex-wrap justify-center space-x-2 md:space-x-4 border-b border-gray-300 pb-3">
                    <button class="tab-button" data-tab="summarizer">Resumidor de Texto</button>
                    <button class="tab-button" data-tab="qa-generator">Generador de Preguntas</button>
                    <button class="tab-button active" data-tab="flashcards">Flashcards Inteligentes</button>
                    <button class="tab-button" data-tab="pdf-upload">Subir PDF para Análisis</button>
                </div>

                <div id="ia-tools-content">
                    <div id="summarizer" class="tab-content hidden">
                        <div class="card-base flat-card max-w-2xl mx-auto">
                            <h3 class="text-xl font-semibold text-primary-dark mb-4 text-center">Resumidor de Texto con IA</h3>
                            <textarea id="textToSummarize" class="input-base w-full h-40 p-3 mb-4 text-sm" placeholder="Pega aquí el texto que quieres resumir..."></textarea>
                            <button id="summarizeBtn" class="button-base flat-button-primary w-full sm:w-auto block mx-auto px-6 py-2">Resumir</button>
                            <div id="summaryOutput" class="mt-5 min-h-[100px] text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"></div>
                        </div>
                    </div>

                    <div id="qa-generator" class="tab-content hidden">
                        <div class="card-base flat-card max-w-2xl mx-auto">
                            <h3 class="text-xl font-semibold text-primary-dark mb-4 text-center">Generador de Preguntas y Respuestas</h3>
                            <textarea id="textForQA" class="input-base w-full h-40 p-3 mb-4 text-sm" placeholder="Pega aquí el texto para generar preguntas..."></textarea>
                            <button id="generateQABtn" class="button-base flat-button-primary w-full sm:w-auto block mx-auto px-6 py-2">Generar Preguntas</button>
                            <div id="qaOutput" class="mt-5 min-h-[100px] text-sm text-gray-700 p-3 bg-gray-50 rounded-md border border-gray-200"></div>
                        </div>
                    </div>

                    <div id="flashcards" class="tab-content"> {/* Default active tab */}
                        <div class="card-base flat-card max-w-lg mx-auto text-center">
                            <h3 class="text-xl font-semibold text-primary-dark mb-2">Flashcards Inteligentes</h3>
                            <p class="text-xs text-gray-500 mb-4">Haz clic en la tarjeta para ver la respuesta.</p>
                            <div class="flashcard-container">
                                <div class="flashcard card-base flat-card" id="flashcard"> {/* Applied flat card style */}
                                    <div class="flashcard-face flashcard-front justify-center items-center flex p-4"></div>
                                    <div class="flashcard-face flashcard-back justify-center items-center flex p-4"></div>
                                </div>
                            </div>
                            <div class="mt-5 flex justify-center space-x-3">
                                <button id="prevFlashcard" class="button-base flat-button px-4 py-2 text-sm"><i class="fas fa-arrow-left mr-1"></i> Anterior</button>
                                <button id="nextFlashcard" class="button-base flat-button px-4 py-2 text-sm">Siguiente <i class="fas fa-arrow-right ml-1"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="pdf-upload" class="tab-content hidden">
                        <div class="card-base flat-card max-w-md mx-auto">
                            <h3 class="text-xl font-semibold text-primary-dark mb-4 text-center">Analiza tus Documentos PDF</h3>
                            <label for="pdfFile" class="block text-sm font-medium text-gray-700 mb-2">Sube un archivo PDF para análisis:</label>
                            <input type="file" id="pdfFile" name="pdfFile" accept=".pdf" class="input-base block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary hover:file:bg-blue-100">
                            <button id="uploadPdfBtn" class="button-base flat-button-primary w-full mt-5 py-2">Subir y Analizar PDF</button>
                            <div id="pdfUploadStatus" class="mt-3 text-sm text-center h-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tecnologia" class="bg-gray-50 scroll-mt-16 py-16 md:py-24"> 
            <div class="container mx-auto px-6">
                <h2 class="section-title">Tecnología Confiable</h2>
                <p class="section-subtitle">Construido con herramientas modernas para una experiencia fluida.</p>
                <div class="card-base flat-card p-8"> 
                    <div class="grid md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-primary-dark mb-3"><i class="fas fa-desktop mr-2"></i>Frontend</h3>
                            <ul class="list-disc list-inside space-y-1 pl-2 text-sm text-gray-700">
                                <li>Vanilla JavaScript con Tailwind CSS</li>
                                <li>CSS Personalizado para estilos base</li>
                                <li>Chart.js para gráficos de progreso</li>
                                <li>Firebase JS SDK (v11.6.1 Módulos ES)</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-primary-dark mb-3"><i class="fas fa-server mr-2"></i>Backend & Base de Datos</h3>
                            <ul class="list-disc list-inside space-y-1 pl-2 text-sm text-gray-700">
                                <li>Firebase (Authentication, Firestore, Storage)</li>
                                <li>Firestore (NoSQL) para datos de usuario</li>
                                <li>Firebase Storage para archivos (PDFs)</li>
                            </ul>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="text-xl font-semibold text-primary-dark mb-3 mt-4"><i class="fas fa-microchip mr-2"></i>Inteligencia Artificial</h3>
                            <p class="mb-2 text-sm text-gray-700">Inicialmente simulado en frontend, con planes de integración real:</p>
                            <ul class="list-disc list-inside space-y-1 pl-2 text-sm text-gray-700">
                                <li>Procesamiento de Lenguaje Natural (NLP): APIs (OpenAI, Cohere) o modelos Hugging Face.</li>
                                <li>Algoritmos de Aprendizaje Adaptativo: Lógica personalizada.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="progreso-dev" class="bg-white scroll-mt-16 py-16 md:py-24">
             <div class="container mx-auto px-6">
                <h2 class="section-title">Tu Panel de Progreso</h2>
                <p class="section-subtitle">Visualiza tu avance y mantente motivado.</p>
                
                <div id="progressChartContainer"> 
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </section>

        <section id="como-funciona" class="bg-gray-50 scroll-mt-16 py-16 md:py-24"> 
            <div class="container mx-auto px-6">
                <h2 class="section-title">Cómo Empezar</h2>
                <p class="section-subtitle">Sigue estos simples pasos para potenciar tu aprendizaje.</p>
                <div class="space-y-8 md:space-y-0 md:grid md:grid-cols-3 md:gap-x-8">
                    <div class="card-base flat-card p-6 text-center">
                        <div class="text-4xl text-primary mb-4"><i class="fas fa-user-plus"></i></div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">1. Regístrate</h3>
                        <p class="text-sm text-gray-600">Crea tu cuenta gratuita en segundos.</p>
                    </div>
                    <div class="card-base flat-card p-6 text-center">
                        <div class="text-4xl text-primary mb-4"><i class="fas fa-tools"></i></div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">2. Explora Herramientas</h3>
                        <p class="text-sm text-gray-600">Prueba nuestras funciones IA gratuitas y considera las Premium.</p>
                    </div>
                    <div class="card-base flat-card p-6 text-center">
                        <div class="text-4xl text-primary mb-4"><i class="fas fa-rocket"></i></div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">3. Potencia tu Estudio</h3>
                        <p class="text-sm text-gray-600">Suscríbete para acceso ilimitado y funciones avanzadas.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300 py-12 text-center">
        <div class="container mx-auto px-6">
            <p class="text-sm">&copy; <span id="currentYear"></span> TU IA DE ESTUDIO. Todos los derechos reservados.</p>
            <p class="text-xs text-gray-500 mt-1">Transformando el aprendizaje con Inteligencia Artificial.</p>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content card-base flat-card"> 
            <span class="modal-close" data-modal-id="loginModal">&times;</span>
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Iniciar Sesión</h2>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="input-base" required> 
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" class="input-base" required> 
                </div>
                <button type="submit" class="button-base flat-button-primary w-full py-2.5">Login</button> 
            </form>
            <p id="loginError" class="text-red-500 text-xs mt-3 text-center h-3"></p>
            <p class="mt-3 text-center text-xs">¿No tienes cuenta? <a href="#" id="showRegisterLink" class="text-primary hover:underline font-medium">Regístrate</a></p>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content card-base flat-card"> 
            <span class="modal-close" data-modal-id="registerModal">&times;</span>
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Crear Cuenta</h2>
            <form id="registerForm" class="space-y-5">
                <div>
                    <label for="registerName" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                    <input type="text" id="registerName" class="input-base" required> 
                </div>
                <div>
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="registerEmail" class="input-base" required> 
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="registerPassword" class="input-base" required minlength="6"> 
                </div>
                <button type="submit" class="button-base flat-button-primary w-full py-2.5">Registrarse</button> 
            </form>
            <p id="registerError" class="text-red-500 text-xs mt-3 text-center h-3"></p>
            <p class="mt-3 text-center text-xs">¿Ya tienes cuenta? <a href="#" id="showLoginLink" class="text-primary hover:underline font-medium">Inicia Sesión</a></p>
        </div>
    </div>
    
    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content card-base flat-card"> 
            <span class="modal-close" data-modal-id="subscriptionModal">&times;</span>
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Desbloquea Todo el Potencial</h2>
            <p class="text-center text-xs text-gray-600 mb-5">Elige un plan para acceder a funciones premium como análisis de documentos y herramientas IA avanzadas.</p>
            
            <div class="card-base bg-primary-light-transparent p-4 mb-5 border border-gray-200 rounded-lg"> 
                <h3 class="text-lg font-semibold text-primary-dark mb-1">Plan Premium Mensual</h3>
                <p class="text-2xl font-bold mb-1 text-primary-dark">$20 <span class="text-sm font-normal text-gray-600">/ mes</span></p>
                <p class="text-xs text-gray-500 mb-3">Acceso completo, almacenamiento ilimitado, soporte prioritario.</p>
                <button id="subscribeBtn" class="button-base flat-button-primary w-full py-2">Suscribirse (Simulado)</button> 
            </div>

            <div id="paymentSimulation" class="hidden mt-4">
                 <h4 class="text-sm font-semibold text-gray-700 mb-1">Simulación de Pago (Crypto):</h4>
                 <p class="text-xs text-gray-600 mb-1">1. Envía <strong class="text-primary">20 USDT</strong> (BEP20/BSC) a:</p>
                 <p class="input-base !text-xs !p-1.5 my-1 break-all bg-gray-100">0xAbCdEf1234567890AbCdEf1234567890AbCdEf12</p> 
                 <p class="text-xs text-gray-600 mb-2">2. Una vez enviado, haz clic en "Confirmar Pago".</p>
                 <button id="confirmPaymentBtn" class="button-base flat-button w-full !py-1.5 text-sm">Confirmar Pago (Simulado)</button> 
            </div>
            <p id="subscriptionMsg" class="text-center mt-2 text-xs h-3"></p>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content card-base flat-card text-center"> 
            <span class="modal-close" data-modal-id="messageModal">&times;</span>
            <h2 id="messageModalTitle" class="text-xl font-semibold text-gray-800 mb-3">Mensaje</h2>
            <p id="messageModalText" class="text-md text-gray-600 mb-5"></p>
            <button id="messageModalCloseBtn" class="button-base flat-button-primary px-6 py-2">Entendido</button> 
        </div>
    </div>

    <script type="module">
        // Firebase App (Core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Authentication
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firebase Firestore (Database)
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Firebase Storage
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // Renamed 'ref' to 'storageRef' to avoid conflict with DOM ref

        // It's highly recommended to manage API keys via environment variables or a secure backend.
        const firebaseConfig = {
            apiKey: "AIzaSyD_keM1ifeE9I2ttjFZyGYEGu9E34m8ns8", 
            authDomain: "study-ia-15ac8.firebaseapp.com", 
            projectId: "study-ia-15ac8",   
            storageBucket: "study-ia-15ac8.firebasestorage.app", 
            messagingSenderId: "27148653401", 
            appId: "1:27148653401:web:d7ebcda9d30b3e65c2f248", 
            measurementId: "G-W2QDH8MERJ" 
        };

        // Initialize Firebase (local scope)
        const firebaseApp = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(firebaseApp);
        const firestoreDB = getFirestore(firebaseApp);
        const firebaseStorage = getStorage(firebaseApp);

        // Global state variables (can be localized further if desired, but kept on window for now as per instructions)
        window.currentUser = null; 
        window.userSubscriptionPlan = 'free'; 
        
        // DOM Elements
        const uiElements = {
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            authButtons: document.getElementById('authButtons'),
            userProfileContainer: document.getElementById('userProfileContainer'),
            userName: document.getElementById('userName'),
            userAvatar: document.getElementById('userAvatar'),
            dashboardLink: document.getElementById('dashboardLink'),
            heroCtaBtn: document.getElementById('heroCtaBtn'), 
            
            loginModal: document.getElementById('loginModal'),
            registerModal: document.getElementById('registerModal'),
            subscriptionModal: document.getElementById('subscriptionModal'),
            messageModal: document.getElementById('messageModal'),

            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            
            showRegisterLink: document.getElementById('showRegisterLink'),
            showLoginLink: document.getElementById('showLoginLink'),

            subscribeBtn: document.getElementById('subscribeBtn'),
            ctaSubscribeFeatures: document.getElementById('ctaSubscribeFeatures'),
            paymentSimulation: document.getElementById('paymentSimulation'),
            confirmPaymentBtn: document.getElementById('confirmPaymentBtn'),
            subscriptionMsg: document.getElementById('subscriptionMsg'),

            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            mainNav: document.getElementById('mainNav'),
            navLinks: document.querySelectorAll('.nav-link'),
            sections: document.querySelectorAll('main section[id]'),

            messageModalTitle: document.getElementById('messageModalTitle'),
            messageModalText: document.getElementById('messageModalText'),
            messageModalCloseBtn: document.getElementById('messageModalCloseBtn'),

            currentYear: document.getElementById('currentYear'),
            progressChartCanvas: document.getElementById('progressChart'),

            // AI Tools UI Elements (to be managed by subscription status)
            summarizeBtn: document.getElementById('summarizeBtn'),
            textToSummarize: document.getElementById('textToSummarize'),
            summaryOutput: document.getElementById('summaryOutput'),
            generateQABtn: document.getElementById('generateQABtn'),
            textForQA: document.getElementById('textForQA'),
            qaOutput: document.getElementById('qaOutput'),
            
            // AI Tool Tab buttons for visual cues
            summarizerTabBtn: document.querySelector('[data-tab="summarizer"]'),
            qaGeneratorTabBtn: document.querySelector('[data-tab="qa-generator"]'),
            flashcardsTabBtn: document.querySelector('[data-tab="flashcards"]'), 
            pdfUploadTabBtn: document.querySelector('[data-tab="pdf-upload"]') 
        };

        // --- Modal Logic ---
        const openModal = (modal) => { 
            if (modal) modal.style.display = 'flex'; 
            setTimeout(() => { 
                if (modal && modal.firstElementChild) modal.firstElementChild.classList.add('modal-open-animate');
            }, 10);
        };
        const closeModal = (modal) => {
            if (modal && modal.firstElementChild) {
                modal.firstElementChild.classList.remove('modal-open-animate'); 
            }
            if (modal) modal.style.display = 'none';
        };

        uiElements.loginBtn?.addEventListener('click', () => openModal(uiElements.loginModal));
        
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeModal(document.getElementById(btn.dataset.modalId)));
        });
        uiElements.messageModalCloseBtn?.addEventListener('click', () => closeModal(uiElements.messageModal));

        window.addEventListener('click', (event) => {
            if (event.target === uiElements.loginModal) closeModal(uiElements.loginModal);
            if (event.target === uiElements.registerModal) closeModal(uiElements.registerModal);
            if (event.target === uiElements.subscriptionModal) closeModal(uiElements.subscriptionModal);
            if (event.target === uiElements.messageModal) closeModal(uiElements.messageModal);
        });
        
        // Make showMessageModal globally available
        window.showMessageModal = (title, text) => {
            if(uiElements.messageModalTitle) uiElements.messageModalTitle.textContent = title;
            if(uiElements.messageModalText) uiElements.messageModalText.textContent = text;
            openModal(uiElements.messageModal);
        };

        // --- Auth UI & Logic ---
        uiElements.logoutBtn?.addEventListener('click', () => {
            signOut(firebaseAuth).catch(error => console.error("Sign out error", error));
        });

        uiElements.showRegisterLink?.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal(uiElements.loginModal);
            openModal(uiElements.registerModal);
        });
        uiElements.showLoginLink?.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal(uiElements.registerModal);
            openModal(uiElements.loginModal);
        });

        onAuthStateChanged(firebaseAuth, async (user) => {
            window.currentUser = user;
            if (user) {
                renderProgressChart(); 
                uiElements.authButtons?.classList.add('hidden');
                uiElements.userProfileContainer?.classList.remove('hidden');
                uiElements.userProfileContainer?.classList.add('flex');
                uiElements.dashboardLink?.classList.remove('hidden');
                uiElements.userName.textContent = user.displayName || user.email.split('@')[0];
                if(user.photoURL) uiElements.userAvatar.src = user.photoURL;
                else uiElements.userAvatar.src = `https://via.placeholder.com/40?text=${(user.displayName || user.email)[0].toUpperCase()}`;

                try {
                    const userDocRef = doc(firestoreDB, 'users', user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().subscriptionPlan) {
                        window.userSubscriptionPlan = docSnap.data().subscriptionPlan;
                    } else {
                        window.userSubscriptionPlan = 'free'; 
                        if (!docSnap.exists()) { 
                             await setDoc(userDocRef, {
                                displayName: user.displayName,
                                email: user.email,
                                createdAt: serverTimestamp(),
                                subscriptionPlan: 'free'
                            });
                        }
                    }
                } catch (err) {
                    console.error("Error fetching/creating user data:", err);
                    window.userSubscriptionPlan = 'free';
                }
            } else {
                uiElements.authButtons?.classList.remove('hidden');
                uiElements.userProfileContainer?.classList.add('hidden');
                uiElements.userProfileContainer?.classList.remove('flex');
                uiElements.dashboardLink?.classList.add('hidden');
                uiElements.userName.textContent = '';
                uiElements.userAvatar.src = 'https://via.placeholder.com/40?text=U';
                window.userSubscriptionPlan = 'free';
            }
            updateUIBasedOnSubscription();
            renderProgressChart(); 
        });

        uiElements.loginForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = uiElements.loginForm.loginEmail.value;
            const password = uiElements.loginForm.loginPassword.value;
            const errorEl = document.getElementById('loginError');
            if(errorEl) errorEl.textContent = '';

            signInWithEmailAndPassword(firebaseAuth, email, password)
                .then(userCredential => {
                    closeModal(uiElements.loginModal);
                    uiElements.loginForm.reset();
                })
                .catch(error => {
                    if(errorEl) errorEl.textContent = error.message.includes("auth/invalid-credential") ? "Credenciales incorrectas." : error.message;
                    console.error("Login Error:", error);
                });
        });

        uiElements.registerForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = uiElements.registerForm.registerName.value;
            const email = uiElements.registerForm.registerEmail.value;
            const password = uiElements.registerForm.registerPassword.value;
            const errorEl = document.getElementById('registerError');
            if(errorEl) errorEl.textContent = '';

            createUserWithEmailAndPassword(firebaseAuth, email, password)
                .then(async (userCredential) => {
                    await updateProfile(userCredential.user, { displayName: name });
                    const userDocRef = doc(firestoreDB, "users", userCredential.user.uid);
                    await setDoc(userDocRef, {
                        displayName: name,
                        email: email,
                        createdAt: serverTimestamp(),
                        subscriptionPlan: 'free'
                    });
                    closeModal(uiElements.registerModal);
                    uiElements.registerForm.reset();
                })
                .catch(error => {
                    if(errorEl) errorEl.textContent = error.message;
                    console.error("Register Error:", error);
                });
        });
        
        const handleSubscriptionClick = () => {
            if (!window.currentUser) {
                showMessageModal("Autenticación Requerida", "Por favor, inicia sesión o regístrate para suscribirte.");
                return;
            }
             if (window.userSubscriptionPlan === 'premium') {
                showMessageModal("Ya Suscrito", "¡Ya disfrutas de nuestro Plan Premium!");
                return;
            }
            openModal(uiElements.subscriptionModal);
            uiElements.paymentSimulation?.classList.add('hidden'); 
            if(uiElements.subscriptionMsg) uiElements.subscriptionMsg.textContent = ''; 
        };
        
        uiElements.subscribeBtn?.addEventListener('click', () => {
            uiElements.paymentSimulation?.classList.remove('hidden');
            if(uiElements.subscriptionMsg) {
                uiElements.subscriptionMsg.textContent = 'Sigue las instrucciones para completar el pago.';
                uiElements.subscriptionMsg.className = 'text-center mt-3 text-sm text-blue-600 h-4';
            }
        });
        uiElements.ctaSubscribeFeatures?.addEventListener('click', handleSubscriptionClick);


        uiElements.confirmPaymentBtn?.addEventListener('click', async () => {
            if (!window.currentUser) return; 

            if(uiElements.subscriptionMsg) {
                uiElements.subscriptionMsg.textContent = 'Procesando confirmación...';
                uiElements.subscriptionMsg.className = 'text-center mt-3 text-sm text-blue-600 h-4';
            }
            uiElements.confirmPaymentBtn.disabled = true;

            try {
                const userDocRef = doc(firestoreDB, "users", window.currentUser.uid);
                await updateDoc(userDocRef, {
                    subscriptionPlan: 'premium',
                    subscriptionUpdatedAt: serverTimestamp()
                });
                window.userSubscriptionPlan = 'premium';
                updateUIBasedOnSubscription();
                if(uiElements.subscriptionMsg) {
                    uiElements.subscriptionMsg.textContent = '¡Suscripción Premium Activada! Gracias.';
                    uiElements.subscriptionMsg.className = 'text-center mt-3 text-sm text-green-600 font-semibold h-4';
                }
                setTimeout(() => closeModal(uiElements.subscriptionModal), 2500);
            } catch (error) {
                console.error("Error updating subscription:", error);
                 if(uiElements.subscriptionMsg) {
                    uiElements.subscriptionMsg.textContent = 'Error al actualizar. Intenta de nuevo.';
                    uiElements.subscriptionMsg.className = 'text-center mt-3 text-sm text-red-500 h-4';
                }
            } finally {
                 uiElements.confirmPaymentBtn.disabled = false;
            }
        });
        
        window.updateUIBasedOnSubscription = () => {
            const isPremium = window.userSubscriptionPlan === 'premium';

            if (uiElements.subscribeBtn) {
                uiElements.subscribeBtn.textContent = isPremium ? 'Ya Estás Suscrito' : 'Suscribirse (Simulado)';
                uiElements.subscribeBtn.disabled = isPremium;
            }
            if (uiElements.ctaSubscribeFeatures) {
                 uiElements.ctaSubscribeFeatures.textContent = isPremium ? 'Acceso Premium Activado' : 'Acceder a Funciones Premium';
                 uiElements.ctaSubscribeFeatures.disabled = isPremium;
                 // Use flat button styles for ctaSubscribeFeatures
                 if(isPremium) {
                    uiElements.ctaSubscribeFeatures.classList.remove('flat-button-primary');
                    uiElements.ctaSubscribeFeatures.classList.add('flat-button'); // A less prominent style for "already active"
                 } else {
                    uiElements.ctaSubscribeFeatures.classList.remove('flat-button');
                    uiElements.ctaSubscribeFeatures.classList.add('flat-button-primary');
                 }
            }
            
             document.querySelectorAll('#caracteristicas .feature-title').forEach(titleEl => { // Keep this selector for now if #caracteristicas still exists
                const originalText = titleEl.dataset.originalText || titleEl.textContent;
                titleEl.dataset.originalText = originalText; 

                if (originalText.includes('(Premium)')) {
                    if (isPremium) {
                        titleEl.innerHTML = originalText.replace('(Premium)', '<span class="text-xs text-accent ml-1">(Activado)</span>');
                    } else {
                        titleEl.innerHTML = originalText; 
                    }
                }
            });

            const premiumMessage = 'Función Premium. Suscríbete para desbloquear.';
            const defaultSummarizerTitle = 'Resumidor de Texto';
            const defaultQAGeneratorTitle = 'Generador de Preguntas';

            if (uiElements.summarizeBtn) uiElements.summarizeBtn.disabled = !isPremium;
            if (uiElements.textToSummarize) uiElements.textToSummarize.disabled = !isPremium;
            if (uiElements.generateQABtn) uiElements.generateQABtn.disabled = !isPremium;
            if (uiElements.textForQA) uiElements.textForQA.disabled = !isPremium;

            if (uiElements.summarizerTabBtn) {
                uiElements.summarizerTabBtn.style.opacity = isPremium ? '1' : '0.65';
                uiElements.summarizerTabBtn.title = isPremium ? defaultSummarizerTitle : premiumMessage;
            }
            if (uiElements.qaGeneratorTabBtn) {
                uiElements.qaGeneratorTabBtn.style.opacity = isPremium ? '1' : '0.65';
                uiElements.qaGeneratorTabBtn.title = isPremium ? defaultQAGeneratorTitle : premiumMessage;
            }
            if (uiElements.flashcardsTabBtn) {
                uiElements.flashcardsTabBtn.style.opacity = '1';
                uiElements.flashcardsTabBtn.title = 'Flashcards Inteligentes';
            }
            if (uiElements.pdfUploadTabBtn) {
                uiElements.pdfUploadTabBtn.style.opacity = '1';
                uiElements.pdfUploadTabBtn.title = 'Subir PDF para Análisis';
            }

            if (!isPremium) {
                if (uiElements.summaryOutput) uiElements.summaryOutput.innerHTML = `<p class="text-center text-accent p-4">${premiumMessage}</p>`;
                if (uiElements.qaOutput) uiElements.qaOutput.innerHTML = `<p class="text-center text-accent p-4">${premiumMessage}</p>`;
            } else {
                 if (uiElements.summaryOutput && uiElements.summaryOutput.innerHTML.includes(premiumMessage)) {
                    uiElements.summaryOutput.innerHTML = '';
                 }
                 if (uiElements.qaOutput && uiElements.qaOutput.innerHTML.includes(premiumMessage)) {
                    uiElements.qaOutput.innerHTML = '';
                 }
            }
        };

        if(uiElements.currentYear) uiElements.currentYear.textContent = new Date().getFullYear();
        
        const updateActiveLink = () => {
            let currentSectionId = '';
            const headerHeight = document.getElementById('mainHeader')?.offsetHeight || 70; // Fallback if header not found
            uiElements.sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (window.scrollY >= sectionTop - (headerHeight + 25) ) { 
                    currentSectionId = section.getAttribute('id');
                }
            });

            uiElements.navLinks.forEach(link => {
                link.classList.remove('active-link');
                if (link.getAttribute('href') === `#${currentSectionId}`) {
                    link.classList.add('active-link');
                }
            });
        };
        window.addEventListener('scroll', updateActiveLink);
        updateActiveLink(); 

        uiElements.navLinks.forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    const headerOffset = document.getElementById('mainHeader')?.offsetHeight || 70; 
                    const elementPosition = targetElement.getBoundingClientRect().top + window.scrollY;
                    const offsetPosition = elementPosition - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
                if (uiElements.mainNav.classList.contains('active')) { 
                    uiElements.mainNav.classList.remove('active');
                     const icon = uiElements.mobileMenuBtn.querySelector('i');
                     icon?.classList.remove('fa-times');
                     icon?.classList.add('fa-bars');
                }
            });
        });
        
        uiElements.mobileMenuBtn?.addEventListener('click', () => {
            uiElements.mainNav?.classList.toggle('active');
            const icon = uiElements.mobileMenuBtn.querySelector('i');
            icon?.classList.toggle('fa-bars');
            icon?.classList.toggle('fa-times');
        });

        uiElements.dashboardLink?.addEventListener('click', (e) => {
            e.preventDefault();
            if (!window.currentUser) {
                openModal(uiElements.loginModal);
            } else if (window.userSubscriptionPlan !== 'premium') {
                handleSubscriptionClick();
            } else {
                showMessageModal("Dashboard Acceso", "¡Bienvenido a tu Dashboard Premium! (Contenido del dashboard se mostraría aquí).");
            }
        });
         uiElements.heroCtaBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            if (!window.currentUser) {
                openModal(uiElements.loginModal);
            } else {
                const caracteristicasSection = document.getElementById('caracteristicas'); // This will be the new #ia-tools section eventually
                if (caracteristicasSection) { // If #caracteristicas is removed, this should point to #ia-tools
                     const headerOffset = document.getElementById('mainHeader')?.offsetHeight || 70;
                     const elementPosition = caracteristicasSection.getBoundingClientRect().top + window.scrollY;
                     const offsetPosition = elementPosition - headerOffset;
                     window.scrollTo({ top: offsetPosition, behavior: 'smooth'});
                }
            }
        });
        
        let progressChartInstance = null;
        const renderProgressChart = async () => {
            if (!uiElements.progressChartCanvas) return;
            const ctx = uiElements.progressChartCanvas.getContext('2d');

            let chartDataConfig = {
                labels: ['Sin datos'],
                datasets: [{
                    label: 'Horas de Estudio',
                    data: [],
                    backgroundColor: 'rgba(var(--color-primary-rgb), 0.2)',
                    borderColor: 'var(--color-primary)',
                    borderWidth: 2,
                    borderRadius: 5,
                    tension: 0.3,
                    fill: true,
                }, {
                    label: 'Tareas Completadas',
                    data: [],
                    backgroundColor: 'rgba(var(--color-accent-rgb, 255 171 118) / 0.2)', 
                    borderColor: 'var(--color-accent)',
                    borderWidth: 2,
                    borderRadius: 5,
                    tension: 0.3,
                    fill: true,
                }]
            };
            let chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { 
                    legend: { display: true, position: 'bottom' },
                    title: { display: true, text: 'Progreso del Estudio (Datos de Ejemplo)' } 
                }
            };

            if (window.currentUser) {
                try {
                    const userDocRef = doc(firestoreDB, 'users', window.currentUser.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists() && docSnap.data().progressEntries && docSnap.data().progressEntries.length > 0) {
                        const progressEntries = docSnap.data().progressEntries.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)); 
                        
                        chartDataConfig.labels = progressEntries.map(entry => entry.label);
                        chartDataConfig.datasets[0].data = progressEntries.map(entry => entry.studyHours || 0);
                        chartDataConfig.datasets[1].data = progressEntries.map(entry => entry.tasksCompleted || 0);
                        chartOptions.plugins.title.text = 'Mi Progreso de Estudio';
                    } else {
                        chartDataConfig.labels = ['Semana 1 (Ej.)', 'Semana 2 (Ej.)', 'Semana 3 (Ej.)', 'Semana 4 (Ej.)'];
                        chartDataConfig.datasets[0].data = [5, 7, 6, 8];
                        chartDataConfig.datasets[1].data = [10, 12, 15, 13];
                        chartOptions.plugins.title.text = 'Progreso (Ejemplo - Registra tu actividad)';
                    }
                } catch (error) {
                    console.error("Error fetching progress data:", error);
                    chartDataConfig.labels = ['Error al cargar datos'];
                    chartOptions.plugins.title.text = 'Error al cargar datos de progreso';
                }
            } else {
                chartDataConfig.labels = ['Fase 1 (Ej.)', 'Fase 2 (Ej.)', 'Fase 3 (Ej.)'];
                chartDataConfig.datasets[0].data = [10, 20, 5]; 
                chartDataConfig.datasets[1].data = [3, 5, 2];   
                chartOptions.plugins.title.text = 'Progreso General (Ejemplo - Inicia Sesión para ver el tuyo)';
            }

            if (progressChartInstance) {
                progressChartInstance.destroy();
            }
            
            if (!document.documentElement.style.getPropertyValue('--color-accent-rgb')) {
                 document.documentElement.style.setProperty('--color-accent-rgb', '108, 117, 125'); 
            }

            progressChartInstance = new Chart(ctx, {
                type: 'line', 
                data: chartDataConfig,
                options: chartOptions
            });
        };
        
    </script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const summarizeBtnDOM = document.getElementById('summarizeBtn');
            const textToSummarizeDOM = document.getElementById('textToSummarize');
            const summaryOutputDOM = document.getElementById('summaryOutput');

            const generateQABtnDOM = document.getElementById('generateQABtn');
            const textForQADOM = document.getElementById('textForQA');
            const qaOutputDOM = document.getElementById('qaOutput');
            
            const showGlobalMessageModal = (title, message) => {
                if (typeof window.showMessageModal === 'function') { 
                    window.showMessageModal(title, message);
                } else { 
                    alert(`${title}: ${message}`);
                }
            };
            
            if (summarizeBtnDOM) {
                summarizeBtnDOM.addEventListener('click', function() {
                    if (window.userSubscriptionPlan !== 'premium') {
                        showGlobalMessageModal("Función Premium", "El Resumidor de Texto requiere una suscripción Premium.");
                        if (summaryOutputDOM) summaryOutputDOM.innerHTML = '<p class="text-center text-accent p-4">Función Premium. Suscríbete para usar el resumidor.</p>';
                        return;
                    }
                    const text = textToSummarizeDOM.value.trim();
                    if (text && summaryOutputDOM) {
                        summaryOutputDOM.innerHTML = '<p class="text-gray-500">Procesando resumen (simulado)...</p>';
                        setTimeout(() => {
                            const summary = "Este es un resumen simulado del texto proporcionado. " + text.substring(0, Math.min(text.length, 150)) + "... (Simulación)";
                            summaryOutputDOM.innerHTML = `<div class="neumorphic-card !shadow-[var(--neumorphism-light-shadow-inset)] !p-4"><h4 class="font-semibold text-primary mb-2">Resumen Generado:</h4><p class="text-sm">${summary}</p></div>`;
                        }, 1500);
                    } else if (summaryOutputDOM) {
                        summaryOutputDOM.innerHTML = '<p class="text-red-500 text-center">Por favor, ingresa texto para resumir.</p>';
                    }
                });
            }

            if (generateQABtnDOM) {
                generateQABtnDOM.addEventListener('click', function() {
                     if (window.userSubscriptionPlan !== 'premium') {
                        showGlobalMessageModal("Función Premium", "El Generador de Preguntas requiere una suscripción Premium.");
                        if (qaOutputDOM) qaOutputDOM.innerHTML = '<p class="text-center text-accent p-4">Función Premium. Suscríbete para generar preguntas.</p>';
                        return;
                    }
                    const text = textForQADOM.value.trim();
                    if (text && qaOutputDOM) {
                        qaOutputDOM.innerHTML = '<p class="text-gray-500">Generando Q&A (simulado)...</p>';
                        setTimeout(() => {
                            qaOutputDOM.innerHTML = `
                                <div class="neumorphic-card !shadow-[var(--neumorphism-light-shadow-inset)] !p-4 space-y-3">
                                    <div>
                                        <h4 class="font-semibold text-primary">Pregunta 1 (Simulada):</h4>
                                        <p class="text-sm">¿Cuál es el concepto principal presentado en el texto?</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-primary">Respuesta 1 (Simulada):</h4>
                                        <p class="text-sm">El concepto principal es la demostración de funcionalidades simuladas.</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-primary">Pregunta 2 (Simulada):</h4>
                                        <p class="text-sm">¿Qué tecnologías se mencionan en el contexto del desarrollo?</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-primary">Respuesta 2 (Simulada):</h4>
                                        <p class="text-sm">Se mencionan HTML, CSS, JavaScript y Firebase.</p>
                                    </div>
                                </div>`;
                        }, 1500);
                    } else if (qaOutputDOM) {
                        qaOutputDOM.innerHTML = '<p class="text-red-500 text-center">Por favor, ingresa texto para generar Q&A.</p>';
                    }
                });
            }

            const flashcard = document.getElementById('flashcard');
            const prevFlashcardBtn = document.getElementById('prevFlashcard');
            const nextFlashcardBtn = document.getElementById('nextFlashcard');
            if (flashcard) {
                const flashcardFront = flashcard.querySelector('.flashcard-front');
                const flashcardBack = flashcard.querySelector('.flashcard-back');
                let currentFlashcardIndex = 0;
                const flashcardData = [ 
                    { q: "¿Qué es Neumorfismo?", a: "Un estilo de diseño que simula volumen y tacto con sombras y luces suaves." },
                    { q: "¿Versión de Firebase SDK usada?", a: "11.6.1 (Módulos ES)" },
                    { q: "¿Qué es Tailwind CSS?", a: "Un framework CSS de utilidad primero (utility-first)." }
                ];

                function updateFlashcardDisplay() {
                    if (!flashcardData || flashcardData.length === 0 || !flashcardFront || !flashcardBack) return;
                    flashcardFront.textContent = `Pregunta: ${flashcardData[currentFlashcardIndex].q}`;
                    flashcardBack.textContent = `Respuesta: ${flashcardData[currentFlashcardIndex].a}`;
                    flashcard.classList.remove('is-flipped');
                }

                flashcard.addEventListener('click', () => flashcard.classList.toggle('is-flipped'));
                prevFlashcardBtn?.addEventListener('click', () => {
                    currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcardData.length) % flashcardData.length;
                    updateFlashcardDisplay();
                });
                nextFlashcardBtn?.addEventListener('click', () => {
                    currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcardData.length;
                    updateFlashcardDisplay();
                });
                if(flashcardData.length > 0) updateFlashcardDisplay();
            }
            
            const uploadPdfBtn = document.getElementById('uploadPdfBtn');
            const pdfFile = document.getElementById('pdfFile');
            const pdfUploadStatus = document.getElementById('pdfUploadStatus');
            uploadPdfBtn?.addEventListener('click', () => {
                if (pdfFile?.files?.length > 0) {
                    const fileName = pdfFile.files[0].name;
                    if(pdfUploadStatus) {
                        pdfUploadStatus.textContent = `Subiendo "${fileName}" (simulado)...`;
                        pdfUploadStatus.className = 'text-center mt-3 text-sm text-blue-600 h-4';
                    }
                    setTimeout(() => {
                        if(pdfUploadStatus) {
                            pdfUploadStatus.textContent = `"${fileName}" analizado con éxito (simulado).`;
                            pdfUploadStatus.className = 'text-center mt-3 text-sm text-green-600 h-4';
                        }
                        if(pdfFile) pdfFile.value = '';
                    }, 2000);
                } else if (pdfUploadStatus) {
                    pdfUploadStatus.textContent = 'Por favor, selecciona un archivo PDF.';
                    pdfUploadStatus.className = 'text-center mt-3 text-sm text-red-500 h-4';
                }
            });

            const tabButtons = document.querySelectorAll('#ia-tools-tabs .tab-button');
            const tabContents = document.querySelectorAll('#ia-tools-content .tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    if ((tabId === 'summarizer' || tabId === 'qa-generator') && window.userSubscriptionPlan !== 'premium') {
                         showGlobalMessageModal("Función Premium", `El acceso a "${button.textContent.trim()}" requiere una suscripción Premium.`);
                         return;
                    }

                    tabButtons.forEach(btn => btn.classList.remove('active', '!bg-primary', 'text-white'));
                    button.classList.add('active', '!bg-primary', 'text-white');
                    
                    tabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });
            
            const activeTabInitially = document.querySelector('#ia-tools-tabs .tab-button.active');
            let tabToActivate = null;

            if (activeTabInitially) {
                const activeTabId = activeTabInitially.dataset.tab;
                 if ((activeTabId === 'summarizer' || activeTabId === 'qa-generator') && window.userSubscriptionPlan !== 'premium'){
                    tabToActivate = Array.from(tabButtons).find(btn => btn.dataset.tab === 'flashcards' || btn.dataset.tab === 'pdf-upload');
                 }
            } else if (tabButtons.length > 0) { 
                 tabToActivate = Array.from(tabButtons).find(btn => btn.dataset.tab === 'flashcards' || btn.dataset.tab === 'pdf-upload');
            }
            
            if (tabToActivate) {
                tabToActivate.click();
            } else if (!activeTabInitially && tabButtons.length > 0) {
                tabButtons[0].click(); 
            }
        });
    </script>
</body>
</html>
